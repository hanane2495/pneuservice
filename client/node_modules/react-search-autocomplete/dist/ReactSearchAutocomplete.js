"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = ReactSearchAutocomplete;

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _fuse = _interopRequireDefault(require("fuse.js"));

var _defaults = require("./defaults/defaults");

var _Results = _interopRequireDefault(require("./Results/Results"));

var _StyledReactSearchAutocomplete = require("./StyledReactSearchAutocomplete");

var _SearchInput = _interopRequireDefault(require("./SearchInput/SearchInput"));

var _styledComponents = require("styled-components");

var _utils = require("./utils/utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _iterableToArrayLimit(arr, i) { if (!(Symbol.iterator in Object(arr) || Object.prototype.toString.call(arr) === "[object Arguments]")) { return; } var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function ReactSearchAutocomplete(props) {
  var items = props.items,
      fuseOptions = props.fuseOptions,
      useCaching = props.useCaching,
      inputDebounce = props.inputDebounce,
      onSearch = props.onSearch,
      onSelect = props.onSelect,
      onFocus = props.onFocus,
      showIcon = props.showIcon,
      maxResults = props.maxResults,
      placeholder = props.placeholder,
      autoFocus = props.autoFocus,
      styling = props.styling;

  var theme = _objectSpread({}, _defaults.defaultTheme, {}, styling);

  var options = _objectSpread({}, _defaults.defaultFuseOptions, {}, fuseOptions);

  var _React$useState = _react["default"].useState(""),
      _React$useState2 = _slicedToArray(_React$useState, 2),
      searchString = _React$useState2[0],
      setSearchString = _React$useState2[1];

  var _React$useState3 = _react["default"].useState(),
      _React$useState4 = _slicedToArray(_React$useState3, 2),
      results = _React$useState4[0],
      setResults = _React$useState4[1];

  _react["default"].useEffect(function () {
    if (useCaching) sessionStorage.clear();
  }, [items]);

  _react["default"].useEffect(function () {
    var keyword = searchString.toLowerCase();

    if (keyword.length > 0) {
      var fuse = new _fuse["default"](items, options);
      var newResults = fuse.search(searchString);

      if (useCaching) {
        if (keyword in sessionStorage) {
          setResults(JSON.parse(sessionStorage.getItem(keyword)));
        } else {
          sessionStorage.setItem(keyword, JSON.stringify(newResults));
          setResults(newResults);
        }
      } else {
        setResults(newResults);
      }
    } else {
      setResults([]);
    }
  }, [searchString, items, useCaching]); // This is used to debounce the onSearch props function


  var debounceOnSearch = _react["default"].useCallback(inputDebounce > 0 ? (0, _utils.debounce)(function (keyword, cached) {
    return onSearch(keyword, cached);
  }, inputDebounce) : function (keyword, cached) {
    return onSearch(keyword, cached);
  }, []);

  var handleSetSearchString = function handleSetSearchString(event) {
    setSearchString(event.target.value);
    var keyword = event.target.value.toLowerCase();

    if (useCaching) {
      onSearch && debounceOnSearch(event.target.value, (0, _utils.isCached)(keyword));
    } else {
      onSearch && debounceOnSearch(event.target.value, false);
    }
  };

  return _react["default"].createElement(_styledComponents.ThemeProvider, {
    theme: theme
  }, _react["default"].createElement(_defaults.GlobalStyle, null), _react["default"].createElement(_StyledReactSearchAutocomplete.StyledReactSearchAutocomplete, null, _react["default"].createElement("div", {
    className: "wrapper"
  }, _react["default"].createElement(_SearchInput["default"], {
    searchString: searchString,
    setSearchString: handleSetSearchString,
    autoFocus: autoFocus,
    onBlur: function onBlur() {
      return setResults([]);
    },
    onFocus: onFocus,
    placeholder: placeholder,
    showIcon: showIcon
  }), _react["default"].createElement(_Results["default"], {
    results: results,
    onClick: onSelect,
    setSearchString: setSearchString,
    showIcon: showIcon,
    maxResults: maxResults
  }))));
}

ReactSearchAutocomplete.defaultProps = {
  items: [],
  fuseOptions: _defaults.defaultFuseOptions,
  useCaching: true,
  inputDebounce: 200,
  showIcon: true,
  maxResults: 10,
  placeholder: "",
  autoFocus: false,
  styling: {}
};
ReactSearchAutocomplete.propTypes = {
  items: _propTypes["default"].array,
  fuseOptions: _propTypes["default"].object,
  useCaching: _propTypes["default"].bool,
  inputDebounce: _propTypes["default"].number,
  onSearch: _propTypes["default"].func,
  onSelect: _propTypes["default"].func,
  onFocus: _propTypes["default"].func,
  showIcon: _propTypes["default"].bool,
  maxResults: _propTypes["default"].number,
  placeholder: _propTypes["default"].string,
  autoFocus: _propTypes["default"].bool,
  styling: _propTypes["default"].object
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9SZWFjdFNlYXJjaEF1dG9jb21wbGV0ZS5qcyJdLCJuYW1lcyI6WyJSZWFjdFNlYXJjaEF1dG9jb21wbGV0ZSIsInByb3BzIiwiaXRlbXMiLCJmdXNlT3B0aW9ucyIsInVzZUNhY2hpbmciLCJpbnB1dERlYm91bmNlIiwib25TZWFyY2giLCJvblNlbGVjdCIsIm9uRm9jdXMiLCJzaG93SWNvbiIsIm1heFJlc3VsdHMiLCJwbGFjZWhvbGRlciIsImF1dG9Gb2N1cyIsInN0eWxpbmciLCJ0aGVtZSIsImRlZmF1bHRUaGVtZSIsIm9wdGlvbnMiLCJkZWZhdWx0RnVzZU9wdGlvbnMiLCJSZWFjdCIsInVzZVN0YXRlIiwic2VhcmNoU3RyaW5nIiwic2V0U2VhcmNoU3RyaW5nIiwicmVzdWx0cyIsInNldFJlc3VsdHMiLCJ1c2VFZmZlY3QiLCJzZXNzaW9uU3RvcmFnZSIsImNsZWFyIiwia2V5d29yZCIsInRvTG93ZXJDYXNlIiwibGVuZ3RoIiwiZnVzZSIsIkZ1c2UiLCJuZXdSZXN1bHRzIiwic2VhcmNoIiwiSlNPTiIsInBhcnNlIiwiZ2V0SXRlbSIsInNldEl0ZW0iLCJzdHJpbmdpZnkiLCJkZWJvdW5jZU9uU2VhcmNoIiwidXNlQ2FsbGJhY2siLCJjYWNoZWQiLCJoYW5kbGVTZXRTZWFyY2hTdHJpbmciLCJldmVudCIsInRhcmdldCIsInZhbHVlIiwiZGVmYXVsdFByb3BzIiwicHJvcFR5cGVzIiwiUHJvcFR5cGVzIiwiYXJyYXkiLCJvYmplY3QiLCJib29sIiwibnVtYmVyIiwiZnVuYyIsInN0cmluZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFFZSxTQUFTQSx1QkFBVCxDQUFpQ0MsS0FBakMsRUFBd0M7QUFBQSxNQUduREMsS0FIbUQsR0FlakRELEtBZmlELENBR25EQyxLQUhtRDtBQUFBLE1BSW5EQyxXQUptRCxHQWVq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IGZyb20gXCJyZWFjdFwiO1xyXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gXCJwcm9wLXR5cGVzXCI7XHJcbmltcG9ydCBGdXNlIGZyb20gXCJmdXNlLmpzXCI7XHJcbmltcG9ydCB7IGRlZmF1bHRUaGVtZSwgR2xvYmFsU3R5bGUsIGRlZmF1bHRGdXNlT3B0aW9ucyB9IGZyb20gXCIuL2RlZmF1bHRzL2RlZmF1bHRzXCI7XHJcbmltcG9ydCBSZXN1bHRzIGZyb20gXCIuL1Jlc3VsdHMvUmVzdWx0c1wiO1xyXG5pbXBvcnQgeyBTdHlsZWRSZWFjdFNlYXJjaEF1dG9jb21wbGV0ZSB9IGZyb20gXCIuL1N0eWxlZFJlYWN0U2VhcmNoQXV0b2NvbXBsZXRlXCI7XHJcbmltcG9ydCBTZWFyY2hJbnB1dCBmcm9tIFwiLi9TZWFyY2hJbnB1dC9TZWFyY2hJbnB1dFwiO1xyXG5pbXBvcnQgeyBUaGVtZVByb3ZpZGVyIH0gZnJvbSAnc3R5bGVkLWNvbXBvbmVudHMnXHJcbmltcG9ydCB7IGRlYm91bmNlLCBpc0NhY2hlZCB9IGZyb20gXCIuL3V0aWxzL3V0aWxzXCI7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBSZWFjdFNlYXJjaEF1dG9jb21wbGV0ZShwcm9wcykge1xyXG5cclxuICBjb25zdCB7XHJcbiAgICBpdGVtcyxcclxuICAgIGZ1c2VPcHRpb25zLFxyXG4gICAgdXNlQ2FjaGluZyxcclxuICAgIGlucHV0RGVib3VuY2UsXHJcbiAgICBvblNlYXJjaCxcclxuICAgIG9uU2VsZWN0LFxyXG4gICAgb25Gb2N1cyxcclxuICAgIHNob3dJY29uLFxyXG4gICAgbWF4UmVzdWx0cyxcclxuICAgIHBsYWNlaG9sZGVyLFxyXG4gICAgYXV0b0ZvY3VzLFxyXG4gICAgc3R5bGluZyxcclxuICB9ID0gcHJvcHM7XHJcblxyXG4gIGNvbnN0IHRoZW1lID0gey4uLmRlZmF1bHRUaGVtZSwgLi4uc3R5bGluZ307XHJcbiAgY29uc3Qgb3B0aW9ucyA9IHsuLi5kZWZhdWx0RnVzZU9wdGlvbnMsIC4uLmZ1c2VPcHRpb25zfTtcclxuXHJcbiAgY29uc3QgW3NlYXJjaFN0cmluZywgc2V0U2VhcmNoU3RyaW5nXSA9IFJlYWN0LnVzZVN0YXRlKFwiXCIpO1xyXG4gIGNvbnN0IFtyZXN1bHRzLCBzZXRSZXN1bHRzXSA9IFJlYWN0LnVzZVN0YXRlKCk7XHJcblxyXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XHJcbiAgICBpZiAodXNlQ2FjaGluZykgc2Vzc2lvblN0b3JhZ2UuY2xlYXIoKTtcclxuICB9LCBbaXRlbXNdKTtcclxuXHJcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcclxuXHJcbiAgICBjb25zdCBrZXl3b3JkID0gc2VhcmNoU3RyaW5nLnRvTG93ZXJDYXNlKCk7XHJcblxyXG4gICAgaWYgKGtleXdvcmQubGVuZ3RoID4gMCkge1xyXG4gICAgICBjb25zdCBmdXNlID0gbmV3IEZ1c2UoaXRlbXMsIG9wdGlvbnMpO1xyXG4gICAgICBjb25zdCBuZXdSZXN1bHRzID0gZnVzZS5zZWFyY2goc2VhcmNoU3RyaW5nKTtcclxuICAgICAgaWYgKHVzZUNhY2hpbmcpIHtcclxuICAgICAgICBpZiAoa2V5d29yZCBpbiBzZXNzaW9uU3RvcmFnZSkgeyBcclxuICAgICAgICAgIHNldFJlc3VsdHMoSlNPTi5wYXJzZShzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGtleXdvcmQpKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oa2V5d29yZCwgSlNPTi5zdHJpbmdpZnkobmV3UmVzdWx0cykpO1xyXG4gICAgICAgICAgc2V0UmVzdWx0cyhuZXdSZXN1bHRzKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgc2V0UmVzdWx0cyhuZXdSZXN1bHRzKTtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgc2V0UmVzdWx0cyhbXSk7XHJcbiAgICB9XHJcbiAgfSwgW3NlYXJjaFN0cmluZywgaXRlbXMsIHVzZUNhY2hpbmddKVxyXG5cclxuICAvLyBUaGlzIGlzIHVzZWQgdG8gZGVib3VuY2UgdGhlIG9uU2VhcmNoIHByb3BzIGZ1bmN0aW9uXHJcbiAgY29uc3QgZGVib3VuY2VPblNlYXJjaCA9IFJlYWN0LnVzZUNhbGxiYWNrKFxyXG4gICAgaW5wdXREZWJvdW5jZSA+IDAgP1xyXG4gICAgICBkZWJvdW5jZSgoa2V5d29yZCwgY2FjaGVkKSA9PiBvblNlYXJjaChrZXl3b3JkLCBjYWNoZWQpLCBpbnB1dERlYm91bmNlKVxyXG4gICAgOlxyXG4gICAgICAoa2V5d29yZCwgY2FjaGVkKSA9PiBvblNlYXJjaChrZXl3b3JkLCBjYWNoZWQpLCBbXSk7XHJcblxyXG4gIGNvbnN0IGhhbmRsZVNldFNlYXJjaFN0cmluZyA9IGV2ZW50ID0+IHtcclxuICAgIHNldFNlYXJjaFN0cmluZyhldmVudC50YXJnZXQudmFsdWUpO1xyXG4gICAgY29uc3Qga2V5d29yZCA9IGV2ZW50LnRhcmdldC52YWx1ZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgaWYgKHVzZUNhY2hpbmcpIHtcclxuICAgICAgb25TZWFyY2ggJiYgZGVib3VuY2VPblNlYXJjaChldmVudC50YXJnZXQudmFsdWUsIGlzQ2FjaGVkKGtleXdvcmQpKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIG9uU2VhcmNoICYmIGRlYm91bmNlT25TZWFyY2goZXZlbnQudGFyZ2V0LnZhbHVlLCBmYWxzZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gKFxyXG4gICAgPFRoZW1lUHJvdmlkZXIgdGhlbWU9e3RoZW1lfT5cclxuICAgICAgPEdsb2JhbFN0eWxlIC8+XHJcbiAgICAgIDxTdHlsZWRSZWFjdFNlYXJjaEF1dG9jb21wbGV0ZT5cclxuICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cIndyYXBwZXJcIj5cclxuICAgICAgICAgIDxTZWFyY2hJbnB1dFxyXG4gICAgICAgICAgICBzZWFyY2hTdHJpbmc9e3NlYXJjaFN0cmluZ31cclxuICAgICAgICAgICAgc2V0U2VhcmNoU3RyaW5nPXtoYW5kbGVTZXRTZWFyY2hTdHJpbmd9XHJcbiAgICAgICAgICAgIGF1dG9Gb2N1cz17YXV0b0ZvY3VzfVxyXG4gICAgICAgICAgICBvbkJsdXI9eygpID0+IHNldFJlc3VsdHMoW10pfVxyXG4gICAgICAgICAgICBvbkZvY3VzPXtvbkZvY3VzfVxyXG4gICAgICAgICAgICBwbGFjZWhvbGRlcj17cGxhY2Vob2xkZXJ9XHJcbiAgICAgICAgICAgIHNob3dJY29uPXtzaG93SWNvbn1cclxuICAgICAgICAgIC8+XHJcbiAgICAgICAgICA8UmVzdWx0c1xyXG4gICAgICAgICAgICByZXN1bHRzPXtyZXN1bHRzfVxyXG4gICAgICAgICAgICBvbkNsaWNrPXtvblNlbGVjdH1cclxuICAgICAgICAgICAgc2V0U2VhcmNoU3RyaW5nPXtzZXRTZWFyY2hTdHJpbmd9XHJcbiAgICAgICAgICAgIHNob3dJY29uPXtzaG93SWNvbn1cclxuICAgICAgICAgICAgbWF4UmVzdWx0cz17bWF4UmVzdWx0c31cclxuICAgICAgICAgIC8+XHJcbiAgICAgICAgPC9kaXY+XHJcbiAgICAgIDwvU3R5bGVkUmVhY3RTZWFyY2hBdXRvY29tcGxldGU+XHJcbiAgICA8L1RoZW1lUHJvdmlkZXI+XHJcbiAgKVxyXG59XHJcblxyXG5SZWFjdFNlYXJjaEF1dG9jb21wbGV0ZS5kZWZhdWx0UHJvcHMgPSB7XHJcbiAgaXRlbXM6IFtdLFxyXG4gIGZ1c2VPcHRpb25zOiBkZWZhdWx0RnVzZU9wdGlvbnMsXHJcbiAgdXNlQ2FjaGluZzogdHJ1ZSxcclxuICBpbnB1dERlYm91bmNlOiAyMDAsXHJcbiAgc2hvd0ljb246IHRydWUsXHJcbiAgbWF4UmVzdWx0czogMTAsXHJcbiAgcGxhY2Vob2xkZXI6IFwiXCIsXHJcbiAgYXV0b0ZvY3VzOiBmYWxzZSxcclxuICBzdHlsaW5nOiB7fSxcclxufVxyXG5cclxuUmVhY3RTZWFyY2hBdXRvY29tcGxldGUucHJvcFR5cGVzID0ge1xyXG4gIGl0ZW1zOiBQcm9wVHlwZXMuYXJyYXksXHJcbiAgZnVzZU9wdGlvbnM6IFByb3BUeXBlcy5vYmplY3QsXHJcbiAgdXNlQ2FjaGluZzogUHJvcFR5cGVzLmJvb2wsXHJcbiAgaW5wdXREZWJvdW5jZTogUHJvcFR5cGVzLm51bWJlcixcclxuICBvblNlYXJjaDogUHJvcFR5cGVzLmZ1bmMsXHJcbiAgb25TZWxlY3Q6IFByb3BUeXBlcy5mdW5jLFxyXG4gIG9uRm9jdXM6IFByb3BUeXBlcy5mdW5jLFxyXG4gIHNob3dJY29uOiBQcm9wVHlwZXMuYm9vbCxcclxuICBtYXhSZXN1bHRzOiBQcm9wVHlwZXMubnVtYmVyLFxyXG4gIHBsYWNlaG9sZGVyOiBQcm9wVHlwZXMuc3RyaW5nLFxyXG4gIGF1dG9Gb2N1czogUHJvcFR5cGVzLmJvb2wsXHJcbiAgc3R5bGluZzogUHJvcFR5cGVzLm9iamVjdCxcclxufSJdfQ==